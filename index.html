<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Node-framed-msgpack-rpc by maxtaco</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1 class="header">Node-framed-msgpack-rpc</h1>
        <p class="header">A variant of Msgpack-RPC that has faster decoding.</p>

        <ul>
          <li class="download"><a class="buttons" href="https://github.com/maxtaco/node-framed-msgpack-rpc/zipball/master">Download ZIP</a></li>
          <li class="download"><a class="buttons" href="https://github.com/maxtaco/node-framed-msgpack-rpc/tarball/master">Download TAR</a></li>
          <li><a class="buttons github" href="https://github.com/maxtaco/node-framed-msgpack-rpc">View On GitHub</a></li>
        </ul>

        <p class="header">This project is maintained by <a class="header name" href="https://github.com/maxtaco">maxtaco</a></p>


      </header>
      <section>
        <h2>Framed Msgpack RPC</h2>

<p><code>framed-msgpack-rpc</code> (FMPRPC) is an RPC system for node.js.  It allows
clients to call remote procedures on servers.  An RPC consists of: (1)
a string name; (2) an argument that is a single JSON object;
(3) a reply that is also a single JSON object.  Of course, those
objects can be arrays, or dictionaries, so arguments and return values
can be complex and interesting.</p>

<p>FMRPC is a variant of the
<a href="http://redmine.msgpack.org/projects/msgpack/wiki/RPCDesign">Msgpack-RPC</a>
protocol specification for node.js.  Msgpack-RPC communicates
binary JSON objects that are efficiently encoded and decoded with the
<a href="http://msgpack.org">MessagePack</a> serialization format. </p>

<p>"Framed" Msgpack-RPC differs from standard Msgpack-RPC in a small way:
the encoding of the length of the packet is prepended to each
packet. This way, receivers can efficiently buffer data until a full
packet is available to decode. In an event-based context like node.js,
framing simplifies implementation, and yields a faster decoder,
especially for very large messages.</p>

<p>By convention, RPCs are grouped into <em>programs</em>, which can have
one or more <em>versions</em>.  Each (prog,vers) pair then has a collection
of procedures, meaning an RPC is identified unabmiguously by a 
(prog,vers,proc) triple.  In practice, these three strings are
joined with "." characters, and the dotted triple is the RPC name.</p>

<p>Due to framing, this protocol is not compatible with existing
Msgpack-RPC systems.  This implementation supports TCP transports only
at the current time.</p>

<h2>Simple Use</h2>

<p>The most simple way to write a server is with the <code>Server</code>
class as below:</p>

<div class="highlight"><pre><span class="kd">var</span> <span class="nx">rpc</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'framed-msgpack-rpc'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">srv</span><span class="o">=</span> <span class="k">new</span> <span class="nx">rpc</span><span class="p">.</span><span class="nx">Server</span> <span class="p">({</span>
    <span class="nx">programs</span> <span class="o">:</span> <span class="p">{</span>
        <span class="s2">"myprog.1"</span> <span class="o">:</span> <span class="p">{</span>
            <span class="nx">add</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">arg</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">response</span><span class="p">.</span><span class="nx">result</span><span class="p">(</span><span class="nx">arg</span><span class="p">.</span><span class="nx">a</span> <span class="o">+</span> <span class="nx">arg</span><span class="p">.</span><span class="nx">b</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">port</span> <span class="o">:</span> <span class="mi">8000</span> 
<span class="p">});</span>
<span class="nx">srv</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Error binding: "</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Listening!"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>

<p>a corresponding client might look like:</p>

<div class="highlight"><pre><span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">rpc</span><span class="p">.</span><span class="nx">createTransport</span><span class="p">({</span> <span class="nx">host</span><span class="o">:</span> <span class="s1">'127.0.0.1'</span><span class="p">,</span> <span class="nx">port</span> <span class="o">:</span> <span class="mi">8000</span> <span class="p">});</span>
<span class="nx">x</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"error connecting"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">rpc</span><span class="p">.</span><span class="nx">Client</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span> <span class="s2">"myprog.1"</span><span class="p">);</span>
        <span class="nx">c</span><span class="p">.</span><span class="nx">invoke</span><span class="p">(</span><span class="s1">'add'</span><span class="p">,</span> <span class="p">{</span> <span class="nx">a</span> <span class="o">:</span> <span class="mi">5</span><span class="p">,</span> <span class="nx">b</span> <span class="o">:</span> <span class="mi">4</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"error in RPC: "</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> 
                <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="nx">response</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nx">x</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>

<p>Or, equivalently, in beautiful 
<a href="https://github.com/maxtaco/coffee-script">IcedCoffeeScript</a>:</p>

<div class="highlight"><pre><span class="nv">x = </span><span class="nx">rpc</span><span class="p">.</span><span class="nx">createTransport</span> <span class="p">{</span> <span class="nv">host: </span><span class="s">'127.0.0.1'</span><span class="p">,</span> <span class="nv">port : </span><span class="mi">8000</span> <span class="p">}</span>
<span class="nx">await</span> <span class="nx">x</span><span class="p">.</span><span class="nx">connect</span> <span class="nx">defer</span> <span class="nx">ok</span>
<span class="k">if</span> <span class="o">not</span> <span class="nx">ok</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">"error connecting"</span>
<span class="k">else</span>
    <span class="nv">c = </span><span class="k">new</span> <span class="nx">rpc</span><span class="p">.</span><span class="nx">Client</span> <span class="nx">x</span><span class="p">,</span> <span class="s">"myprog.1"</span>
    <span class="nx">await</span> <span class="nx">c</span><span class="p">.</span><span class="nx">invoke</span> <span class="s">'add'</span><span class="p">,</span> <span class="p">{</span> <span class="nv">a : </span><span class="mi">5</span><span class="p">,</span> <span class="nv">b : </span><span class="mi">4</span><span class="p">},</span> <span class="nx">defer</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">response</span>
    <span class="k">if</span> <span class="nx">err</span><span class="o">?</span> <span class="k">then</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">"error in RPC: </span><span class="si">#{</span><span class="nx">err</span><span class="si">}</span><span class="s">"</span>
    <span class="k">else</span> <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span> <span class="mi">9</span><span class="p">,</span> <span class="nx">response</span>
    <span class="nx">x</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
</pre></div>

<h2>Installation</h2>

<p>It should work to just install with npm:</p>

<pre><code>npm install -g framed-msgpack-rpc
</code></pre>

<p>If you install by hand, you will need to install the one dependency,
which is the <a href="http://github.com/JulesAU/node-msgpack">Msgpack C bindings</a>,
available as <code>msgpack2</code> on npm:</p>

<pre><code>npm install -g msgpack2
</code></pre>

<p>For full API document, see the GitHub-hosted <a href="https://github.com/maxtaco/node-framed-msgpack-rpc">README</a> file.</p>
      </section>
      <footer>
        <p><small>Hosted on <a href="https://pages.github.com">GitHub Pages</a> using the Dinky theme</small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
		
  </body>
</html>